{% extends "base.html" %}

{% block headscript %}
  <script type="text/javascript">
    var $table, $comment, ai_player, player, losses = 0;
    var winner, game_finished = false;
    var taunting_strs = [" What's goining on? Maybe try harder.",
                         " Wow, that's embarrassing, maybe give up?",
                         " Yawn ... think I'm gonna take a nap."];

    function get_state_from_table() {
        var state = '';
        $table.find("td").each(function (i, e) {
            if ($(e).hasClass('x'))
                state += 'x';
            else if ($(e).hasClass('o'))
                state += 'o';
            else
                state += 'e';
        });
        return state;
    }

    function set_state_to_table(state) {
        $table.find("td").each(function (i, e) {
            $(e).removeClass("x o e X O");
            $(e).addClass(state[i]);
        });
    }

    function reset_table() {
        $table.removeClass("locked");
        set_state_to_table("eeeeeeeee");
        $comment.text("You are playing as " + player.toUpperCase());
        game_finished = false;
        winner = false;
        if (ai_player == 'x')
            make_next_ai_play(true);
    }

    function update_game_finished() {
        if ($table.find(".X").length) {
            game_finished = true;
            winner = 'x';
            return true;
        }
        if ($table.find(".O").length) {
            game_finished = true;
            winner = 'o';
            return true;
        }
        if (!$table.find(".e").length) {
            game_finished = true;
            winner = false;
            return true;
        }
        return false;
    }
   
    function set_player(to_player) {
        player = to_player;
        ai_player = player=='o' ? 'x': 'o';
        reset_table();
    }

    function make_next_ai_play(empty) {
        state = empty ? '': get_state_from_table();
        $table.addClass('locked');
        $.getJSON("{% url 'play' %}",
                  {state: state,
                   ai_player: ai_player},
                  function (data) {
                      set_state_to_table(data.state);
                      $table.removeClass("locked");
                      update_game_finished();
                      if (game_finished) {
                          if (winner == ai_player) {
                              increment_losses();
                              $comment.text("You lost!");
                          } else if (winner == player) {
                              $comment.text("Oops! You Won! That wasn't supposed to happen.");
                          } else {
                              $comment.text("It's a draw!");
                          }
                      }
                  });
    }

    function increment_losses() {
        losses += 1;
        var taunting = losses;
        if (losses > 10)
            taunting += " Wow, that's a lot of losses. Just stop!"
        else if (losses%2 == 0)
            taunting += taunting_strs[(Math.floor(losses/2)-1)%taunting_strs.length];
        $("#losses").text(taunting);
    }

    $(function () {
        $table = $("#tic-tac-toe-table");
        $comment = $("#comment");

        $table.addClass("locked");

        $("#tic-tac-toe-table td").click(function () {            
            if (!$table.hasClass("locked")) {
                if (game_finished) {
                    reset_table();
                } else if ($(this).hasClass('e')) {
                    $(this).removeClass('e');
                    $(this).addClass(player);
                    make_next_ai_play();
                }
            }
        });
        $(".set-player").click(function () {
            set_player($(this).attr('id'));
        });
    });
</script>
{% endblock %}

{% block content %}
<div>Welcome to the Tic Tac Toe!</div>
<div id="comment">Pick a player:</div>
<button type="button" class="set-player" id="x">Play as X</button>
<button type="button" class="set-player" id="o">Play as O</button>
<table id="tic-tac-toe-table">
    <tbody>
        <tr>
            <td class="e top left"></td>
            <td class="e top"></td>
            <td class="e top right"></td>
        </tr>
        <tr>
            <td class="e left"></td>
            <td class="e "></td>
            <td class="e right"></td>
        </tr>
        <tr>
            <td class="e bottom left"></td>
            <td class="e bottom"></td>
            <td class="e bottom right"></td>
        </tr>
    </tbody>
</table>
<div>Your losses: <span id="losses">0</span></div>
<div>AI's losses: 0</div>
{% endblock %}
