{% extends "base.html" %}
{% block title %}Tic-Tac-Toe Demo using Ajax{% endblock %}
{% block script %}

var interCharDelay = 20;
var betweenEl      = 600;

var txtgreeting1 = "GREETINGS PROFESSOR FALKEN";
var txtgreeting2 = "SHALL WE PLAY A GAME?";


var txtoption1   = "GLOBAL THERMONUCLEAR WAR";
var alert1       = "WINNER: NONE";

var txtoption2   = "TIC-TAC-TOE";
var alert2       = "OK: Your move";


var txtgamenames = {
                        "gtw" :       txtoption1,
                        "tictactoe" : txtoption2
                    };


var main         = null;
var greeting     = null;
var games        = {};
var gamenames    = {};

var greeting1    = null;
var greeting2    = null;
var opt1         = null;
var opt2         = null;
var menu1        = null;
var li1          = null;
var li2          = null;

var gamemods          = {
        "gtw" :
            {
            'initGame'    : function(){
                var _result = dojo.byId("result-gtw");
                initializeScrollingElement(_result,alert1,interCharDelay);
            },
            'restartGame' : function(){
                                    try{
                                        _result = dojo.byId("result-gtw");
                                        setTimeout(_result.scrollText,2000);
                                        
                                    }catch(e){ window.alert(e.message); }

            }
            
            },
        
        "tictactoe" :
            {
            'initGame'     : function(){},
            'restartGame'  : function(){ window.alert("x-tictactoe"); }
            }
};

var wipeGreeting   = function(){
    greeting1.innerHTML = '';
    greeting2.innerHTML = '';
    opt1.innerHTML      = '';
    opt2.innerHTML      = '';
    try{
    menu1.removeChild(li1);
    menu1.removeChild(li2);
    }catch(e){}
}
    
var showGreeting   = function(){
    dojo.fadeIn({ node: "greeting" }).play();
    try{
        main.appendChild(greeting);
    }catch(e){}
}
var removeGreeting = function(){
    
    dojo.fadeOut({node:"greeting" }).play();
    wipeGreeting();
    try{
        main.removeChild(greeting);
    }catch(e){
        window.alert("error removing greeting "+e.message);
    }
}
var showGame = function(game){
    //window.alert("showing game "+game);
    try{
        main.appendChild(games[game]);
        gamenames[game].scrollText();
        gamemods[game].restartGame();
    }catch(e){
            window.alert("error showing game ["+game+"] :"+e.message);
    }
}
var removeGame = function(game,fade){
    if(fade){
        dojo.fadeOut({ node: games[game] });
    }
    try{
        main.removeChild(games[game]);
    }catch(e){}
}
var removeBothGames = function(){
    removeGame("gtw",false);
    removeGame("tictactoe",false);
}

var greetProfessorFalken = function(){
    greeting1.scrollText();
}


var initializeScrollingElement = function(element,txt,cdelay){
    element.scrolldelay    = cdelay;
    element.inprogress     = false;
    element.currentindex   = 0;
    element.currenttext    = txt;
    element.currentchars   = txt.split('');

    element._onEnd          = null;

    element.onEnd = function(f,delay){
        element._onEnd    = f;
        element._endDelay = delay;
    }


    element.scrollText = function () {
        element.currentindex = 0;
        element.inprogress   = true;
        element.innerHTML    = '';
        element.scrollNextLetter();
 	
    }
    element.scrollNextLetter = function(){
       if (element.currentindex<element.currentchars.length) {
 		 element.scrolling = setTimeout(
                     function () {

                        letter = document.createTextNode(element.currentchars[element.currentindex]);
 	                if (letter.value == '\\'){ letter.value = ''; }
                        element.appendChild(letter);
                        clearTimeout(element.scrolling);
                        element.currentindex++;
                        element.scrollNextLetter();

                     },	element.scrolldelay);
 	} else {
 		 element.inprogress = false;
                 if(element._onEnd){
                    setTimeout( element._onEnd, element._endDelay);
                 }
 	}

    }



}


var initializeElements = function(){
    main     = dojo.byId("main");
    greeting = dojo.byId("greeting");

    games["gtw"]           = dojo.byId("gtw");
    games["tictactoe"]     = dojo.byId("tictactoe");

    gamenames["gtw"]       = dojo.byId("gamename-gtw");
    gamenames["tictactoe"] = dojo.byId("gamename-tictactoe");
    

    gamemods["gtw"].initGame();
    gamemods["tictactoe"].initGame();

    greeting1 = dojo.byId("greeting1");
    greeting2 = dojo.byId("greeting2");
    menu1     = dojo.byId("menu1");
    opt1      = dojo.create('a',{
                href: '#',
                onclick: function(){
                        removeGreeting();
                        showGame("gtw");
                }
            });
    opt2      = dojo.create('a',{
                href: '#',
                onclick: function(){
                       removeGreeting();
                       showGame("tictactoe");
                }
            });
    li1 = dojo.create('li',{});
    li2 = dojo.create('li',{});
    
    initializeScrollingElement(greeting1,txtgreeting1,interCharDelay);
    initializeScrollingElement(greeting2,txtgreeting2,interCharDelay);
    initializeScrollingElement(opt1,txtoption1,interCharDelay);
    initializeScrollingElement(opt2,txtoption2,interCharDelay);

    initializeScrollingElement(gamenames["gtw"],txtgamenames["gtw"],interCharDelay);
    initializeScrollingElement(gamenames["tictactoe"],txtgamenames["tictactoe"],interCharDelay);
    
    greeting1.onEnd(greeting2.scrollText,betweenEl);
    greeting2.onEnd(function(){
                        
                        dojo.place(opt1,li1);
                        dojo.place(li1,menu1);
                        opt1.scrollText();
                        },betweenEl);
 
    opt1.onEnd(function(){
                        dojo.place(opt2,li2);
                        dojo.place(li2,menu1);
                        opt2.scrollText();
                        },betweenEl);   


}







{% endblock %}
{% block styles %}
#main{
  font-family: monospace;
  font-weight: bold;
  font-size:   24pt;
  margin-top:  2em;
  margin-left: 4em;
  color:       #009;
  
}
#menu1{
  margin-left: 2em;
}
a{
    text-decoration: none;
}
a:link{
        color: #009;
}
a:visited{
        color: #009;
}
a:hover{
        color: #f00;
}
a:active{
        color: #ff0;
}

{% endblock %}
{% block ready %}
    initializeElements();
    removeBothGames();
    greetProfessorFalken();
{% endblock %}
{% block content %}
<div id="main">
<div id="greeting">
<div id="greeting1"></div>
<div id="greeting2"></div>
<ol id="menu1"></ol>
</div>
<div id="gtw">
<div id="gamename-gtw"></div>
<div id="result-gtw"></div>
</div>
<div id="tictactoe">
<div id="gamename-tictactoe"></div>
<div id="result-tictactoe"></div>
</div>
</div>
{% endblock %}
