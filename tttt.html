<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>TTT</title>
	<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
	<!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous">-->
</head>
<style>
	html {
		box-sizing: border-box;
	}
	#header {
		width: 90vw;
		max-width: 600px;
		border: solid 1px black;
		border-radius: 5px;
		padding: 5px;
	}
	#gameSettings {
		display: none;
		margin: 10px;
		background-color: antiquewhite;
		overflow: hidden;
	}

	#show-detail {
		float:right;
	}
	.title {
		font-size: 24px;
		font-weight:bold;
	}
	.settings-label {
		display: inline-block;
		width: 30%;
		text-align: right;
		float: left;
	}
	.settings-value {
		display: inline-block;
		width: 70%;
	}
	.frm-settings {
		clear: both;
	}
	.game-board {
		width: 90vw;
		height: 90vw;
		max-width: 600px;
		max-height: 600px;
		display: inline-block;
		padding: 5px;
		border: solid 1px #000000;
	}
	.play-button {
		display: block;
		float: left;
		width: 30vw;
		height: 30vw;
		max-width: 200px;
		max-height: 200px;
		font-size: 20vw;
		font-weight: bold;
	}

	@media (min-width: 600px) {
		.play-button {
			font-size: 124px;
		}
	}

	.game-over-one {
		background-color: green;
		color: white;
	}
	.game-over-two {
		background-color: blue;
		color: white;
	}
	.game-over-draw {
		background-color: black;
		color: white;
	}

</style>
<script type="text/javascript">
	$(document).ready(function () {
		console.log('document ready');
		/**
		 * 00|01|02
		 * 10|11|12
		 * 20|21|22
		 *
		 * AI move algorithm:
		 * Check and take win if possible (player has any two positions in a win, take the third
		 * If no win, check and take block if required. (Opponent has any two positions in a win, take the third. Logic for win and block are the same!)
		 * No, then take 11 if available.
		 * if not 11 then
		 *  if previous move was [01,10,12,21] take [00,20,02,22]
		 *  if previous move was [00,02,22,20] take [01,12,21,10] match row or column if available, otherwise take nearest
		 * last option, take any free position.
		 *
		 * After each move, check for win. If win, game over with winner.
		 *  if no win, check for full board. If full, game over with draw.
		 * Wins:
		 * [0,1,2][0,1,2]  //rows AND columns
		 * 00,11,22 diagonal 1
		 * 20,11,02 diagonal 2
		 */

		var iRound = 1;														//each player has one turn/round
		var player = 'one';											//Current player. one=first turn, usually "X", 'two' second turn, usually 'O'
		var iPlays = 0;														//used to determine draw
		var gameState = {};												//tracks plays, who has a given position
		var oGamePiece = {one: 'X', two: 'O', oneColor: 'green', twoColor: 'blue'};		//to support user selection of game piece
		var oScores = {one: 0, two: 0};

		var autoNew = 2000;												//automatically start new game after timeout set to -1 to prevent
		var aiMode = 1;														//0=two humans, 1=human vs AI, 2=AI vs AI
		var aiLevel = 'dumb';										//smart=unbeatable, dumb = random plays
		var aiThinking = 500;											//pause while AI thinks
		var bPlayFull = true;											//false ends game when end is predictable
		var bContinueToFull = true;								//allows completion of game when outcome is predictable


		var aDiag1Win = ['00', '11', '22'];				//positions for diagonal wins
		var aDiag2Win = ['20', '11', '02'];
		//row and col wins programmatic
		
		function selectGamePiece(sGamePiece) {
			oGamePiece.one = sGamePiece || 'X';
			oGamePiece.two = (oGamePiece.one === 'X')? 'O':'X';
			$('#oneGamePiece').html(oGamePiece.one);
			$('#twoGamePiece').html(oGamePiece.two);
		}

		//handler for human click
		$('.play-button').click(function (event) {
			var $e = $(this);
			var position = $e.data('position').toString();
			if (!gameState.hasOwnProperty(position)) {				//do not process click if position is already played
				makePlay(position);
			}
		});


		function makePlay(position) {
			iPlays ++;
			var playedElement = $("[data-position='" + position + "']");
			console.log('button text:', playedElement.html());

			playedElement.html(oGamePiece[player]);
			gameState[position] = player;																		//record move
			var gameOver = checkWin(position);
			if (!gameOver) {
				player = (player === 'one') ? 'two' : 'one';									//toggle player
				if (aiMode > 0) {
					setTimeout(aiMove, aiThinking);
				}
			}
		}

		function aiMove() {
			if (aiLevel === 'dumb') {
				var aPositions = ['00','01','02','10','11','12','20','21','22'];
				var index;
				var position;
				do {
					index = getRandomPosition();
					position = aPositions[index];
					if (!gameState[position]) {
						makePlay(position);
						break;
					}
				} while (true)
			}
			else {

			}
		}

		//setup handler for new game button click
		$('#newGame').click(function (onet) {
			newGame(true);
		});
		//setup handler for reset game button click
		$('#resetGame').click(function (onet) {
			resetGame();
		});

		function resetGame() {
			newGame();
			oScores = {one: 0, 'two': 0};
			$("#scoreOne").html(0);
			$("#scoreTwo").html(0);
		}

		/**
		 * resets board, but not scores
		 *
		 */
		function newGame(bManual) {
			for (var position in gameState) {
				var $gameButton = $("button[data-position='" + position + "']");
				$gameButton.html('');
				$gameButton.removeClass(function(index, css){
					return (css.match (/\bgame-over-\S+/g) || []).join(' ');
				});
			}
			$(".game-board").removeClass(function(index, css){
				return (css.match (/\bgame-over-\S+/g) || []).join(' ');
			});
			gameState = {};
			player = 'one';
			iPlays = 0;

			//will play another Ai vs AI game
			if (aiMode === 2 && bManual) {
				aiMove();
			}
		}

		/**
		 * checks last play for a win
		 * @param position
		 */
		function checkWin(position) {
			var row = position.charAt(0);
			var col = position.charAt(1);

			var idxRow = 0;
			var idxCol = 0;
			var i = -1;
			var win = true;
			var winOn = '';													//winOn records type of win
			var key = '';
			console.log('check row');
			winOn = 'r' + row;
			for (idxCol = 0; idxCol < 3; idxCol++) {
				key = row + idxCol;
				console.log('checking ', key);
				if (gameState[key] !== player) {
					win = false;
					break;
				}
			}
			if (!win) {
				//check columns
				console.log('check column');
				win = true;
				winOn = 'c' + col;
				for (idxRow = 0; idxRow < 3; idxRow++) {
					key = idxRow + col;
					console.log('checking ', key);
					if (gameState[key] !== player) {
						win = false;
						break;
					}
				}
			}
			if (!win) {
				win = true;

				//check diagonal not O1, not
				console.log('check diag 1');
				winOn = 'aDiag1Win';
				for (i = 0; i < aDiag1Win.length; i++) {
					if (gameState[aDiag1Win[i]] !== player) {
						win = false;
						break;
					}
				}
				if (!win) {
					win = true;
					winOn = 'aDiag2Win';
					console.log('check diag 2');
					for (i = 0; i < aDiag2Win.length; i++) {
						if (gameState[aDiag2Win[i]] !== player) {
							win = false;
							break;
						}
					}
				}
			}
			if (win) {
				gameOver(winOn);
				return true;
			}
			else if (iPlays === 9) {
				gameOver();
				return true;
			}
			else {
				return false;
			}
		}

		function gameOver(winOn) {
			winOn = winOn || 'draw';
			var sPosition;
			var i = -1;
			if (winOn === 'draw') {
				for (position in gameState) {
					$("button[data-position='" + position + "']").addClass('game-over-draw');
				}
				$(".game-board").addClass('game-over-draw');
			}
			else {
				oScores[player]++;
				$("#score" + player).html(oScores[player]);
				if (winOn === 'aDiag1Win') {
					for (i = 0; i < aDiag1Win.length; i++) {
						sPosition = aDiag1Win[i];
						$("button[data-position='" + sPosition + "']").addClass('game-over-' + player);
					}
				}
				else if (winOn === 'aDiag2Win') {
					for (i = 0; i < aDiag2Win.length; i++) {
						sPosition = aDiag2Win[i];
						$("button[data-position='" + sPosition + "']").addClass('game-over-' + player);
					}
				}
				else if (winOn.charAt(0) === 'r') {
					for (i = 0; i < 3; i++) {
						sPosition = winOn.charAt(1) + i;
						$("button[data-position='" + sPosition + "']").addClass('game-over-' + player);
					}
				}
				else if (winOn.charAt(0) === 'c') {
					for (i = 0; i < 3; i++) {
						sPosition = i + winOn.charAt(1);
						$("button[data-position='" + sPosition + "']").addClass('game-over-' + player);
					}
				}
				$(".game-board").addClass('game-over-' + player);
			}
			if (autoNew > -1) {
				setTimeout(newGame, autoNew);
			}
		}

		//***************************** Game setting/options handlers ********************************/
		$('#show-detail').on('click', function(event){
			var $e = $(this);
			var $collapsible = $('#gameSettings');
			$collapsible.toggle();
			var sDisplay = $collapsible.css('display');
			if (sDisplay === 'none') {
				$e.html('+ options');
			}
			else {
				$e.html('- options');
			}
		});


		$('#frmGamePiece input').on('change', function() {
			selectGamePiece($('input[name="gamePiece"]:checked', '#frmGamePiece').val());
		});


		$('#frmPlayerMode input').on('change', function() {
			aiMode = $('input[name="playerMode"]:checked', '#frmPlayerMode').val();
		});

		function getRandomPosition() {
			return Math.floor(Math.random() * 9);
		}
		
		if (aiMode === 2) {
			aiMove('11');
		}
	});
</script>

<body>
<div id="header" class="header">
	<span class="title">Tracy's TicTacToe Trainer</span>
	<a id="show-detail" href="#" >show game settings</a>
	<div id="gameSettings">
		<form id="frmGamePiece" class="frm-settings">
			<label class="settings-label">Player One Game-Piece:</label>
			<div class="settings-value">
				<input type="radio" name="gamePiece" value="X" checked >"X"
				<input type="radio" name="gamePiece" value="O" >"O"
			</div>

		</form>
		<form id="frmPlayerMode"  class="frm-settings">
			<label class="settings-label">Play Mode:</label>
			<div class="settings-value">
				<input type="radio" name="playerMode" value="0" checked >Player vs Player
				<input type="radio" name="playerMode" value="1" >Player vs AI
				<input type="radio" name="playerMode" value="1" >AI vs AI
			</div>

		</form>

	</div>
	<div class="scores">
		Scores:
		<div>Player One <span id="oneGamePiece">test</span>: <span id="scoreOne">0</span></div>
		<div>Player Two <span id="twoGamePiece"></span>: <span id="scoreTwo">0</span></div>
	</div>

</div>

<div class="game-board">
	<div class="game-row">
		<button class="play-button" data-position="00"></button>
		<button class="play-button" data-position="01"></button>
		<button class="play-button" data-position="02"></button>
	</div>
	<div class="game-row">
		<button class="play-button" data-position="10"></button>
		<button class="play-button" data-position="11"></button>
		<button class="play-button" data-position="12"></button>
	</div>
	<div class="game-row">
		<button class="play-button" data-position="20"></button>
		<button class="play-button" data-position="21"></button>
		<button class="play-button" data-position="22"></button>
	</div>
</div>
<br>
<button id="newGame">New Game</button>
<br>
<button id="resetGame">Reset</button>
</body>
</html>